(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Selector=YAHOO.util.Selector,Bubbling=YAHOO.Bubbling;var $html=Alfresco.util.encodeHTML,$links=Alfresco.util.activateLinks,$combine=Alfresco.util.combinePaths,$userProfile=Alfresco.util.userProfileLink;Alfresco.component.DataGrid=function(htmlId){Alfresco.component.DataGrid.superclass.constructor.call(this,"Alfresco.component.DataGrid",htmlId,["button","container","datasource","datatable","paginator","animation","history"]);this.datalistMeta={};this.datalistColumns={};this.dataRequestFields=[];this.dataResponseFields=[];this.currentPage=1;this.totalRecords=0;this.showingMoreActions=false;this.hideMoreActionsFn=null;this.currentFilter={filterId:"all",filterData:""};this.selectedItems={};this.afterDataGridUpdate=[];Bubbling.on("activeDataListChanged",this.onActiveDataListChanged,this);Bubbling.on("changeFilter",this.onChangeFilter,this);Bubbling.on("filterChanged",this.onFilterChanged,this);Bubbling.on("dataListDetailsUpdated",this.onDataListDetailsUpdated,this);Bubbling.on("dataItemCreated",this.onDataItemCreated,this);Bubbling.on("dataItemUpdated",this.onDataItemUpdated,this);Bubbling.on("dataItemsDeleted",this.onDataItemsDeleted,this);Bubbling.on("dataItemsDuplicated",this.onDataGridRefresh,this);this.deferredListPopulation=new Alfresco.util.Deferred(["onReady","onActiveDataListChanged"],{fn:this.populateDataGrid,scope:this});return this;};YAHOO.extend(Alfresco.component.DataGrid,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.component.DataGrid,Alfresco.service.DataListActions);YAHOO.lang.augmentObject(Alfresco.component.DataGrid.prototype,{options:{siteId:"",containerId:"dataLists",usePagination:false,initialPage:1,pageSize:50,initialFilter:{},actionsPopupTimeout:500,loadingMessageDelay:1000,splitActionsAt:3,editDialogWidth:"34em",actionsColumnWidth:80},currentPage:null,totalRecords:null,currentFilter:null,selectedItems:null,currentActionsMenu:null,hideMoreActionsFn:null,showingMoreActions:null,deferredActionsMenu:null,afterDataGridUpdate:null,datalistMeta:null,datalistColumns:null,dataRequestFields:null,dataResponseFields:null,fnRenderCellSelected:function DataGrid_fnRenderCellSelected(){var scope=this;return function DataGrid_renderCellSelected(elCell,oRecord,oColumn,oData){Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");elCell.innerHTML='<input id="checkbox-'+oRecord.getId()+'" type="checkbox" name="fileChecked" value="'+oData+'"'+(scope.selectedItems[oData]?' checked="checked">':">");};},fnRenderCellActions:function DataGrid_fnRenderCellActions(){var scope=this;return function DataGrid_renderCellActions(elCell,oRecord,oColumn,oData){Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");elCell.innerHTML='<div id="'+scope.id+"-actions-"+oRecord.getId()+'" class="hidden"></div>';};},getCellFormatter:function DataGrid_getCellFormatter(){var scope=this;return function DataGrid_renderCellDataType(elCell,oRecord,oColumn,oData){var html="";if(!oRecord){oRecord=this.getRecord(elCell);}if(!oColumn){oColumn=this.getColumn(elCell.parentNode.cellIndex);}if(oRecord&&oColumn){if(!oData){oData=oRecord.getData("itemData")[oColumn.field];}if(oData){var datalistColumn=scope.datalistColumns[oColumn.key];if(datalistColumn){oData=YAHOO.lang.isArray(oData)?oData:[oData];for(var i=0,ii=oData.length,data;i<ii;i++){data=oData[i];switch(datalistColumn.dataType.toLowerCase()){case"cm:person":html+='<span class="person">'+$userProfile(data.metadata,data.displayValue)+"</span>";break;case"datetime":html+=Alfresco.util.formatDate(Alfresco.util.fromISO8601(data.value),scope.msg("date-format.default"));break;case"date":html+=Alfresco.util.formatDate(Alfresco.util.fromISO8601(data.value),scope.msg("date-format.defaultDateOnly"));break;case"text":html+=$links($html(data.displayValue));break;default:if(datalistColumn.type=="association"){html+='<a href="'+Alfresco.util.siteURL((data.metadata=="container"?"folder":"document")+"-details?nodeRef="+data.value)+'">';html+='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(data.displayValue,(data.metadata=="container"?"cm:folder":null),16)+'" width="16" alt="'+$html(data.displayValue)+'" title="'+$html(data.displayValue)+'" />';html+=" "+$html(data.displayValue)+"</a>";}else{html+=$links($html(data.displayValue));}break;}if(i<ii-1){html+="<br />";}}}}}elCell.innerHTML=html;};},getSortFunction:function DataGrid_getSortFunction(){return function DataGrid_sortFunction(a,b,desc,field){var fieldA=a.getData().itemData[field],fieldB=b.getData().itemData[field];if(YAHOO.lang.isArray(fieldA)){fieldA=fieldA[0];}if(YAHOO.lang.isArray(fieldB)){fieldB=fieldB[0];}if(!YAHOO.lang.isValue(fieldA)){return(!YAHOO.lang.isValue(fieldB))?0:1;}else{if(!YAHOO.lang.isValue(fieldB)){return -1;}}var valA=fieldA.value,valB=fieldB.value;if(valA.indexOf&&valA.indexOf("workspace://SpacesStore")==0){valA=fieldA.displayValue;valB=fieldB.displayValue;}return YAHOO.util.Sort.compare(valA,valB,desc);};},onReady:function DataGrid_onReady(){var me=this;this.widgets.itemSelect=Alfresco.util.createYUIButton(this,"itemSelect-button",this.onItemSelect,{type:"menu",menu:"itemSelect-menu",disabled:true});var fnActionHandler=function DataGrid_fnActionHandler(layer,args){var owner=Bubbling.getOwnerByTagName(args[1].anchor,"div");if(owner!==null){if(typeof me[owner.className]=="function"){args[1].stop=true;var asset=me.widgets.dataTable.getRecord(args[1].target.offsetParent).getData();me[owner.className].call(me,asset,owner);}}return true;};Bubbling.addDefaultAction("action-link",fnActionHandler);Bubbling.addDefaultAction("show-more",fnActionHandler);var fnChangeFilterHandler=function DataGrid_fnChangeFilterHandler(layer,args){var owner=args[1].anchor;if(owner!==null){var filter=owner.rel,filters,filterObj={};if(filter&&filter!==""){args[1].stop=true;filters=filter.split("|");filterObj={filterOwner:window.unescape(filters[0]||""),filterId:window.unescape(filters[1]||""),filterData:window.unescape(filters[2]||""),filterDisplay:window.unescape(filters[3]||"")};Alfresco.logger.debug("DL_fnChangeFilterHandler","changeFilter =>",filterObj);Bubbling.fire("changeFilter",filterObj);}}return true;};Bubbling.addDefaultAction("filter-change",fnChangeFilterHandler);this.modules.actions=new Alfresco.module.DataListActions();this.modules.dataGrid=this;Dom.removeClass(this.id+"-selectListMessage","hidden");this.deferredListPopulation.fulfil("onReady");Dom.setStyle(this.id+"-body","visibility","visible");},onHistoryManagerReady:function DataGrid_onHistoryManagerReady(){Alfresco.logger.debug("DataGrid_onHistoryManagerReady","changeFilter =>",this.options.initialFilter);Bubbling.fire("changeFilter",YAHOO.lang.merge({datagridFirstTimeNav:true},this.options.initialFilter));},_onDataListFailure:function DataGrid__onDataListFailure(p_response,p_message){Alfresco.util.PopupManager.displayPrompt({title:p_message.title,text:p_message.text,modal:true,buttons:[{text:this.msg("button.ok"),handler:function DataGrid__onDataListFailure_OK(){this.destroy();},isDefault:true}]});},renderDataListMeta:function DataGrid_renderDataListMeta(){if(!YAHOO.lang.isObject(this.datalistMeta)){return;}Alfresco.util.populateHTML([this.id+"-title",$html(this.datalistMeta.title)],[this.id+"-description",$links($html(this.datalistMeta.description,true))]);},populateDataGrid:function DataGrid_populateDataGrid(){if(!YAHOO.lang.isObject(this.datalistMeta)){return;}this.renderDataListMeta();Alfresco.util.Ajax.jsonGet({url:$combine(Alfresco.constants.URL_SERVICECONTEXT,"components/data-lists/config/columns?itemType="+encodeURIComponent(this.datalistMeta.itemType)),successCallback:{fn:this.onDatalistColumns,scope:this},failureCallback:{fn:this._onDataListFailure,obj:{title:this.msg("message.error.columns.title"),text:this.msg("message.error.columns.description")},scope:this}});},onDatalistColumns:function DataGrid_onDatalistColumns(response){this.datalistColumns=response.json.columns;this._setupHistoryManagers();this._setupDataSource();this._setupDataTable();Dom.addClass(this.id+"-selectListMessage","hidden");this.widgets.itemSelect.set("disabled",false);YAHOO.util.History.onReady(this.onHistoryManagerReady,this,true);},_setupHistoryManagers:function DataGrid__setupHistoryManagers(){var bookmarkedFilter=YAHOO.util.History.getBookmarkedState("filter");bookmarkedFilter=bookmarkedFilter===null?"all":(YAHOO.env.ua.gecko>0)?bookmarkedFilter:window.escape(bookmarkedFilter);try{while(bookmarkedFilter!=(bookmarkedFilter=decodeURIComponent(bookmarkedFilter))){}}catch(e1){}var fnDecodeBookmarkedFilter=function DataGrid_fnDecodeBookmarkedFilter(strFilter){var filters=strFilter.split("|"),filterObj={filterId:window.unescape(filters[0]||""),filterData:window.unescape(filters[1]||"")};filterObj.filterOwner=Alfresco.util.FilterManager.getOwner(filterObj.filterId);return filterObj;};this.options.initialFilter=fnDecodeBookmarkedFilter(bookmarkedFilter);YAHOO.util.History.register("filter",bookmarkedFilter,function DataGrid_onHistoryManagerFilterChanged(newFilter){Alfresco.logger.debug("HistoryManager: filter changed:"+newFilter);if(YAHOO.env.ua.gecko>0){newFilter=window.unescape(newFilter);Alfresco.logger.debug("HistoryManager: filter (after Firefox fix):"+newFilter);}this._updateDataGrid.call(this,{filter:fnDecodeBookmarkedFilter(newFilter)});},null,this);var me=this;var handlePagination=function DataGrid_handlePagination(state,me){me.widgets.paginator.setState(state);YAHOO.util.History.navigate("page",String(state.page));};if(this.options.usePagination){var bookmarkedPage=YAHOO.util.History.getBookmarkedState("page")||"1";while(bookmarkedPage!=(bookmarkedPage=decodeURIComponent(bookmarkedPage))){}this.currentPage=parseInt(bookmarkedPage||this.options.initialPage,10);YAHOO.util.History.register("page",bookmarkedPage,function DataGrid_onHistoryManagerPageChanged(newPage){Alfresco.logger.debug("HistoryManager: page changed:"+newPage);me.widgets.paginator.setPage(parseInt(newPage,10));this.currentPage=parseInt(newPage,10);},null,this);this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator",this.id+"-paginatorBottom"],rowsPerPage:this.options.pageSize,initialPage:this.currentPage,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",handlePagination,this);Dom.setStyle(this.id+"-datagridBarBottom","display","block");}try{YAHOO.util.History.initialize("yui-history-field","yui-history-iframe");}catch(e2){Alfresco.logger.error(this.name+": Couldn't initialize HistoryManager.",e2);this.onHistoryManagerReady();}},_setupDataSource:function DataGrid__setupDataSource(){var listNodeRef=new Alfresco.util.NodeRef(this.datalistMeta.nodeRef);for(var i=0,ii=this.datalistColumns.length;i<ii;i++){var column=this.datalistColumns[i],columnName=column.name.replace(":","_"),fieldLookup=(column.type=="property"?"prop":"assoc")+"_"+columnName;this.dataRequestFields.push(columnName);this.dataResponseFields.push(fieldLookup);this.datalistColumns[fieldLookup]=column;}this.widgets.dataSource=new YAHOO.util.DataSource(Alfresco.constants.PROXY_URI+"slingshot/datalists/data/node/"+listNodeRef.uri,{connMethodPost:true,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",totalRecords:"totalRecords"}}});this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);this.widgets.dataSource.doBeforeCallback=function DataGrid_doBeforeCallback(oRequest,oFullResponse,oParsedResponse){var permissions=oFullResponse.metadata.parent.permissions;if(permissions&&permissions.userAccess){Bubbling.fire("userAccess",{userAccess:permissions.userAccess});}return oParsedResponse;};},_setupDataTable:function DataGrid__setupDataTable(columns){var columnDefinitions=[{key:"nodeRef",label:"",sortable:false,formatter:this.fnRenderCellSelected(),width:105}];var column;for(var i=0,ii=this.datalistColumns.length;i<ii;i++){column=this.datalistColumns[i];columnDefinitions.push({key:this.dataResponseFields[i],label:column.label,sortable:true,sortOptions:{field:column.formsName,sortFunction:this.getSortFunction()},formatter:this.getCellFormatter(column.dataType)});}columnDefinitions.push({key:"actions",label:this.msg("label.column.actions"),sortable:false,formatter:this.fnRenderCellActions(),width:parseInt(this.options.actionsColumnWidth,10)});var me=this;this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-grid",columnDefinitions,this.widgets.dataSource,{renderLoopSize:this.options.usePagination?16:32,initialLoad:false,dynamicData:false,MSG_EMPTY:this.msg("message.empty"),MSG_ERROR:this.msg("message.error"),MSG_SORTASC:this.msg("message.sortasc"),MSG_SORTDESC:this.msg("message.sortdesc"),paginator:this.widgets.paginator});this.widgets.dataTable.handleDataReturnPayload=function DataGrid_handleDataReturnPayload(oRequest,oResponse,oPayload){me.totalRecords=oResponse.meta.totalRecords;oResponse.meta.pagination={rowsPerPage:me.options.pageSize,recordOffset:(me.currentPage-1)*me.options.pageSize};return oResponse.meta;};this.widgets.dataTable.doBeforeLoadData=function DataGrid_doBeforeLoadData(sRequest,oResponse,oPayload){if(oResponse.error){try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);me.widgets.dataTable.set("MSG_ERROR",response.message);}catch(e){me._setDefaultDataTableErrors(me.widgets.dataTable);}}if(oResponse.results.length===0){this.fireEvent("renderEvent",{type:"renderEvent"});}return true;};this.widgets.dataTable.doBeforeSortColumn=function DataGrid_doBeforeSortColumn(oColumn,sSortDir){me.currentSort={oColumn:oColumn,sSortDir:sSortDir};return true;};this.widgets.dataTable.subscribe("checkboxClickEvent",function(e){var id=e.target.value;this.selectedItems[id]=e.target.checked;Bubbling.fire("selectedItemsChanged");},this,true);this.widgets.dataTable.subscribe("beforeRenderEvent",function(){if(me.currentSort){var oColumn=me.currentSort.oColumn,sSortDir=me.currentSort.sSortDir,sortFnc=(oColumn.sortOptions&&YAHOO.lang.isFunction(oColumn.sortOptions.sortFunction))?oColumn.sortOptions.sortFunction:null;if(sSortDir||sortFnc){sortFnc=sortFnc||this.get("sortFunction");var sField=(oColumn.sortOptions&&oColumn.sortOptions.field)?oColumn.sortOptions.field:oColumn.field;this._oRecordSet.sortRecords(sortFnc,((sSortDir==YAHOO.widget.DataTable.CLASS_DESC)?true:false),sField);}}},this.widgets.dataTable,true);this.widgets.dataTable.subscribe("renderEvent",function(){Alfresco.logger.debug("DataTable renderEvent");if(YAHOO.env.ua.ie<7){var ie6fix=this.widgets.dataTable.getTableEl().parentNode;ie6fix.className=ie6fix.className;}for(var i=0,j=this.afterDataGridUpdate.length;i<j;i++){this.afterDataGridUpdate[i].call(this);}this.afterDataGridUpdate=[];},this,true);this.widgets.dataTable.subscribe("rowMouseoverEvent",this.onEventHighlightRow,this,true);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.onEventUnhighlightRow,this,true);},onItemSelect:function DataGrid_onItemSelect(sType,aArgs,p_obj){var domEvent=aArgs[0],eventTarget=aArgs[1];this.selectItems(Alfresco.util.findEventClass(eventTarget));Event.preventDefault(domEvent);},onEventHighlightRow:function DataGrid_onEventHighlightRow(oArgs){var elActions=Dom.get(this.id+"-actions-"+oArgs.target.id);if(elActions&&elActions.firstChild===null){this.widgets.dataTable.onEventHighlightRow.call(this.widgets.dataTable,oArgs);var record=this.widgets.dataTable.getRecord(oArgs.target.id),clone=Dom.get(this.id+"-actionSet").cloneNode(true);clone.innerHTML=YAHOO.lang.substitute(window.unescape(clone.innerHTML),this.getActionUrls(record));clone.id=elActions.id+"_a";Dom.addClass(clone,"simple");var userAccess=record.getData("permissions").userAccess,actionLabels=record.getData("actionLabels")||{};userAccess["filter-"+this.currentFilter.filterId]=true;var actions=YAHOO.util.Selector.query("div",clone),action,aTag,spanTag,actionPermissions,aP,i,ii,j,jj;for(i=0,ii=actions.length;i<ii;i++){action=actions[i];aTag=action.firstChild;spanTag=aTag.firstChild;if(spanTag&&actionLabels[action.className]){spanTag.innerHTML=$html(actionLabels[action.className]);}if(aTag.rel!==""){actionPermissions=aTag.rel.split(",");for(j=0,jj=actionPermissions.length;j<jj;j++){aP=actionPermissions[j];if((aP.charAt(0)=="~")?!!userAccess[aP.substring(1)]:!userAccess[aP]){clone.removeChild(action);break;}}}}var splitAt=this.options.splitActionsAt;actions=YAHOO.util.Selector.query("div",clone);if(actions.length>splitAt){var moreContainer=Dom.get(this.id+"-moreActions").cloneNode(true);var containerDivs=YAHOO.util.Selector.query("div",moreContainer);Dom.insertBefore(containerDivs[0],actions[splitAt]);Dom.insertBefore(containerDivs[1],actions[splitAt]);var index,moreActions=actions.slice(splitAt);for(index in moreActions){if(moreActions.hasOwnProperty(index)){containerDivs[1].appendChild(moreActions[index]);}}}elActions.appendChild(clone);}if(this.showingMoreActions){this.deferredActionsMenu=elActions;}else{if(!Dom.hasClass(document.body,"masked")){this.currentActionsMenu=elActions;Dom.removeClass(elActions,"hidden");this.deferredActionsMenu=null;}}},onEventUnhighlightRow:function DataGrid_onEventUnhighlightRow(oArgs){this.widgets.dataTable.onEventUnhighlightRow.call(this.widgets.dataTable,oArgs);var elActions=Dom.get(this.id+"-actions-"+(oArgs.target.id));if(!this.showingMoreActions||Dom.hasClass(document.body,"masked")){if(this.hideMoreActionsFn){this.hideMoreActionsFn.call(this);}Dom.addClass(elActions,"hidden");this.deferredActionsMenu=null;}},onActionShowMore:function DataGrid_onActionShowMore(record,elMore){Dom.addClass(elMore.firstChild,"highlighted");var elMoreActions=Dom.getNextSibling(elMore);Dom.removeClass(elMoreActions,"hidden");this.hideMoreActionsFn=function DL_oASM_fnHidePopup(){this.hideMoreActionsFn=null;Dom.removeClass(elMore.firstChild,"highlighted");Dom.addClass(elMoreActions,"hidden");};},getActionUrls:function DataGrid_getActionUrls(record){var recordData=YAHOO.lang.isFunction(record.getData)?record.getData():record,nodeRef=recordData.nodeRef;return({editMetadataUrl:"edit-dataitem?nodeRef="+nodeRef});},getSelectedItems:function DataGrid_getSelectedItems(){var items=[],recordSet=this.widgets.dataTable.getRecordSet(),aPageRecords=this.widgets.paginator.getPageRecords();if(!aPageRecords){return;}var startRecord=aPageRecords[0],endRecord=aPageRecords[1],record;for(var i=startRecord;i<=endRecord;i++){record=recordSet.getRecord(i);if(this.selectedItems[record.getData("nodeRef")]){items.push(record.getData());}}return items;},selectItems:function DataGrid_selectItems(p_selectType){var recordSet=this.widgets.dataTable.getRecordSet(),checks=Selector.query('input[type="checkbox"]',this.widgets.dataTable.getTbodyEl()),aPageRecords=this.widgets.paginator.getPageRecords(),startRecord,len=checks.length,record,i,fnCheck;if(aPageRecords){startRecord=aPageRecords[0];switch(p_selectType){case"selectAll":fnCheck=function(assetType,isChecked){return true;};break;case"selectNone":fnCheck=function(assetType,isChecked){return false;};break;case"selectInvert":fnCheck=function(assetType,isChecked){return !isChecked;};break;default:fnCheck=function(assetType,isChecked){return isChecked;};}for(i=0;i<len;i++){record=recordSet.getRecord(i+startRecord);this.selectedItems[record.getData("nodeRef")]=checks[i].checked=fnCheck(record.getData("type"),checks[i].checked);}Bubbling.fire("selectedItemsChanged");}},onActionEdit:function DataGrid_onActionEdit(item){var scope=this;var doBeforeDialogShow=function DataGrid_onActionEdit_doBeforeDialogShow(p_form,p_dialog){Alfresco.util.populateHTML([p_dialog.id+"-dialogTitle",this.msg("label.edit-row.title")]);};var templateUrl=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"node",itemId:item.nodeRef,mode:"edit",submitType:"json"});var editDetails=new Alfresco.module.SimpleDialog(this.id+"-editDetails");editDetails.setOptions({width:this.options.editDialogWidth,templateUrl:templateUrl,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:doBeforeDialogShow,scope:this},onSuccess:{fn:function DataGrid_onActionEdit_success(response){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/datalists/item/node/"+new Alfresco.util.NodeRef(item.nodeRef).uri,dataObj:this._buildDataGridParams(),successCallback:{fn:function DataGrid_onActionEdit_refreshSuccess(response){Bubbling.fire("dataItemUpdated",{item:response.json.item});Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.success")});},scope:this},failureCallback:{fn:function DataGrid_onActionEdit_refreshFailure(response){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.failure")});},scope:this}});},scope:this},onFailure:{fn:function DataGrid_onActionEdit_failure(response){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.failure")});},scope:this}}).show();},onActiveDataListChanged:function DataGrid_onActiveDataListChanged(layer,args){var obj=args[1];if((obj!==null)&&(obj.dataList!==null)){this.datalistMeta=obj.dataList;if(!this.deferredListPopulation.fulfil("onActiveDataListChanged")){this.populateDataGrid();}}},onDataListDetailsUpdated:function DataGrid_onDataListDetailsUpdated(layer,args){var obj=args[1];if((obj!==null)&&(obj.dataList!==null)){this.dataListMeta=obj.dataList;this.renderDataListMeta();}},onDataGridRefresh:function DataGrid_onDataGridRefresh(layer,args){this._updateDataGrid.call(this,{page:this.currentPage});},onChangeFilter:function DataGrid_onChangeFilter(layer,args){var obj=args[1];if((obj!==null)&&(obj.filterId!==null)){var filter=Alfresco.util.cleanBubblingObject(obj),strFilter=YAHOO.lang.substitute("{filterId}|{filterData}",filter,function(p_key,p_value,p_meta){return typeof p_value=="undefined"?"":window.escape(p_value);}),aFilters=strFilter.split("|");if(aFilters[1].length===0){strFilter=aFilters[0];}Alfresco.logger.debug("DataGrid_onChangeFilter: ",filter);var objNav={filter:strFilter};if(obj.datagridFirstTimeNav){this._updateDataGrid.call(this,{filter:filter,page:this.currentPage});}else{if(this.options.usePagination){this.currentPage=1;objNav.page="1";}Alfresco.logger.debug("DataGrid_onChangeFilter: objNav = ",objNav);YAHOO.util.History.multiNavigate(objNav);}}},onFilterChanged:function DataGrid_onFilterChanged(layer,args){var obj=args[1];if((obj!==null)&&(obj.filterId!==null)){obj.filterOwner=obj.filterOwner||Alfresco.util.FilterManager.getOwner(obj.filterId);this.currentFilter=Alfresco.util.cleanBubblingObject(obj);Alfresco.logger.debug("DL_onFilterChanged: ",this.currentFilter);}},onDataItemCreated:function DataGrid_onDataItemCreated(layer,args){var obj=args[1];if(obj&&(obj.nodeRef!==null)){var nodeRef=new Alfresco.util.NodeRef(obj.nodeRef);Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/datalists/item/node/"+nodeRef.uri,dataObj:this._buildDataGridParams(),successCallback:{fn:function DataGrid_onDataItemCreated_refreshSuccess(response){var item=response.json.item;var fnAfterUpdate=function DataGrid_onDataItemCreated_refreshSuccess_fnAfterUpdate(){var recordFound=this._findRecordByParameter(item.nodeRef,"nodeRef");if(recordFound!==null){var el=this.widgets.dataTable.getTrEl(recordFound);Alfresco.util.Anim.pulse(el);}};this.afterDataGridUpdate.push(fnAfterUpdate);this.widgets.dataTable.addRow(item);},scope:this},failureCallback:{fn:function DataGrid_onDataItemCreated_refreshFailure(response){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create.refresh.failure")});},scope:this}});}},onDataItemUpdated:function DataGrid_onDataItemUpdated(layer,args){var obj=args[1];if(obj&&(obj.item!==null)){var recordFound=this._findRecordByParameter(obj.item.nodeRef,"nodeRef");if(recordFound!==null){this.widgets.dataTable.updateRow(recordFound,obj.item);var el=this.widgets.dataTable.getTrEl(recordFound);Alfresco.util.Anim.pulse(el);}}},onDataItemsDeleted:function DataGrid_onDataItemsDeleted(layer,args){var obj=args[1];if(obj&&(obj.items!==null)){var recordFound,el,fnCallback=function(record){return function DataGrid_onDataItemsDeleted_anim(){this.widgets.dataTable.deleteRow(record);};};for(var i=0,ii=obj.items.length;i<ii;i++){recordFound=this._findRecordByParameter(obj.items[i].nodeRef,"nodeRef");if(recordFound!==null){el=this.widgets.dataTable.getTrEl(recordFound);Alfresco.util.Anim.fadeOut(el,{callback:fnCallback(recordFound),scope:this});}}}},_setDefaultDataTableErrors:function DataGrid__setDefaultDataTableErrors(dataTable){var msg=Alfresco.util.message;dataTable.set("MSG_EMPTY",msg("message.empty","Alfresco.component.DataGrid"));dataTable.set("MSG_ERROR",msg("message.error","Alfresco.component.DataGrid"));},_updateDataGrid:function DataGrid__updateDataGrid(p_obj){p_obj=p_obj||{};Alfresco.logger.debug("DataGrid__updateDataGrid: ",p_obj.filter);var successFilter=YAHOO.lang.merge({},p_obj.filter!==undefined?p_obj.filter:this.currentFilter),loadingMessage=null,timerShowLoadingMessage=null,me=this,params={filter:successFilter};var fnShowLoadingMessage=function DataGrid_fnShowLoadingMessage(){Alfresco.logger.debug("DataGrid__uDG_fnShowLoadingMessage: slow data webscript detected.");if(timerShowLoadingMessage){loadingMessage=Alfresco.util.PopupManager.displayMessage({displayTime:0,text:'<span class="wait">'+$html(this.msg("message.loading"))+"</span>",noEscape:true});if(YAHOO.env.ua.ie>0){this.loadingMessageShowing=true;}else{loadingMessage.showEvent.subscribe(function(){this.loadingMessageShowing=true;},this,true);}}};this._setDefaultDataTableErrors(this.widgets.dataTable);this.showingMoreActions=false;this.loadingMessageShowing=false;timerShowLoadingMessage=YAHOO.lang.later(this.options.loadingMessageDelay,this,fnShowLoadingMessage);var destroyLoaderMessage=function DataGrid__uDG_destroyLoaderMessage(){if(timerShowLoadingMessage){timerShowLoadingMessage.cancel();timerShowLoadingMessage=null;}if(loadingMessage){if(this.loadingMessageShowing){loadingMessage.destroy();loadingMessage=null;}else{YAHOO.lang.later(100,me,destroyLoaderMessage);}}};var successHandler=function DataGrid__uDG_successHandler(sRequest,oResponse,oPayload){destroyLoaderMessage();var fnAfterUpdate=function DataGrid__uDG_sH_fnAfterUpdate(){Bubbling.fire("selectedFilesChanged");};this.afterDataGridUpdate.push(fnAfterUpdate);Alfresco.logger.debug("currentFilter was:",this.currentFilter,"now:",successFilter);this.currentFilter=successFilter;this.currentPage=p_obj.page||1;Bubbling.fire("filterChanged",successFilter);this.widgets.dataTable.onDataReturnReplaceRows.call(this.widgets.dataTable,sRequest,oResponse,oPayload);};var failureHandler=function DataGrid__uDG_failureHandler(sRequest,oResponse){destroyLoaderMessage();this.afterDataGridUpdate=[];if(oResponse.status==401){window.location.reload(true);}else{try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);this.widgets.dataTable.set("MSG_ERROR",response.message);this.widgets.dataTable.showTableMessage(response.message,YAHOO.widget.DataTable.CLASS_ERROR);if(oResponse.status==404){Bubbling.fire("deactivateAllControls");}}catch(e){this._setDefaultDataTableErrors(this.widgets.dataTable);}}};var requestParams=this._buildDataGridParams(params);Alfresco.logger.debug("DataSource requestParams: ",requestParams);if(Alfresco.util.CSRFPolicy.isFilterEnabled()){this.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),false);}this.widgets.dataSource.sendRequest(YAHOO.lang.JSON.stringify(requestParams),{success:successHandler,failure:failureHandler,scope:this});},_buildDataGridParams:function DataGrid__buildDataGridParams(p_obj){var request={fields:this.dataRequestFields};if(p_obj&&p_obj.filter){request.filter={filterId:p_obj.filter.filterId,filterData:p_obj.filter.filterData};}return request;},_findRecordByParameter:function DataGrid__findRecordByParameter(p_value,p_parameter){var recordSet=this.widgets.dataTable.getRecordSet();for(var i=0,j=recordSet.getLength();i<j;i++){if(recordSet.getRecord(i).getData(p_parameter)==p_value){return recordSet.getRecord(i);}}return null;}},true);})();